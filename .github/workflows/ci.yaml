name: CI
on:
  workflow_dispatch:
    inputs:
      auto_update:
        description: 'Automatically update and push flake.lock'
        type: boolean
        default: true
  push:
    paths:
      - '.github/workflows/ci.yaml'
  schedule:
    - cron: '0 0 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  flake:
    permissions:
      contents: write
      id-token: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - uses: chainguard-dev/actions/setup-gitsign@5c235a8fc95ad826debc6363bf5d1c69be78facb  # main

      - uses: cachix/install-nix-action@ba0dd844c9180cbf77aa72a116d6fbc515d0e87b  # v31

      - uses: nix-community/cache-nix-action@1b68d8b44dab0f6262c5f56f0949d03f6324e796  # v6

        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix', '**/flake.lock') }}

      - name: Determine if auto-update should run
        id: should-update
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "auto_update=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "auto_update=${{ inputs.auto_update }}" >> "$GITHUB_OUTPUT"
          else
            echo "auto_update=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update flake.lock
        if: steps.should-update.outputs.auto_update == 'true'
        run: |
          nix flake update --commit-lock-file --option commit-lockfile-summary "chore(deps): flake.lock file maintenance"

      - name: Run flake check
        id: flake-check
        continue-on-error: true
        run: nix flake check --all-systems -L

      - name: Push to main if check passed
        if: steps.should-update.outputs.auto_update == 'true' && steps.flake-check.outcome == 'success'
        run: |
          git push origin HEAD:main

      - name: Create PR if check failed
        if: steps.should-update.outputs.auto_update == 'true' && steps.flake-check.outcome == 'failure'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f  # v7.0.5
        with:
          title: "chore(deps): flake.lock file maintenance"
          body: |
            Automated lockfile update.

            ⚠️ **Flake check failed** - manual review required.
          labels: |
            dependencies
            automated
            chore
            needs-review
          reviewers: "0x77dev"
          signoff: true
          sign-commits: true
          branch: chore/deps/flake-lock

      - name: Report check results (push trigger)
        if: steps.should-update.outputs.auto_update == 'false'
        run: |
          if [[ "${{ steps.flake-check.outcome }}" == "success" ]]; then
            echo "Flake check passed"
          else
            exit 1
          fi
